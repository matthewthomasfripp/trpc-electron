"use strict";var g=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var c=(r,e,t)=>(g(r,e,"read from private field"),t?t.call(r):e.get(r)),R=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},A=(r,e,t,n)=>(g(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);var p=(r,e,t)=>(g(r,e,"access private method"),t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const l=require("electron"),T="trpc-electron";function Y(r){return!!r&&!Array.isArray(r)&&typeof r=="object"}class $ extends Error{}function Q(r){if(r instanceof Error)return r;const e=typeof r;if(!(e==="undefined"||e==="function"||r===null)){if(e!=="object")return new Error(String(r));if(Y(r)){const t=new $;for(const n in r)t[n]=r[n];return t}}}function y(r){if(r instanceof N||r instanceof Error&&r.name==="TRPCError")return r;const e=new N({code:"INTERNAL_SERVER_ERROR",cause:r});return r instanceof Error&&r.stack&&(e.stack=r.stack),e}class N extends Error{constructor(e){const t=Q(e.cause),n=e.message??(t==null?void 0:t.message)??e.code;super(n,{cause:t}),this.code=e.code,this.name="TRPCError",this.cause||(this.cause=t)}}const V={PARSE_ERROR:-32700,BAD_REQUEST:-32600,INTERNAL_SERVER_ERROR:-32603,NOT_IMPLEMENTED:-32603,UNAUTHORIZED:-32001,FORBIDDEN:-32003,NOT_FOUND:-32004,METHOD_NOT_SUPPORTED:-32005,TIMEOUT:-32008,CONFLICT:-32009,PRECONDITION_FAILED:-32012,UNSUPPORTED_MEDIA_TYPE:-32015,PAYLOAD_TOO_LARGE:-32013,UNPROCESSABLE_CONTENT:-32022,TOO_MANY_REQUESTS:-32029,CLIENT_CLOSED_REQUEST:-32099},j={PARSE_ERROR:400,BAD_REQUEST:400,UNAUTHORIZED:401,NOT_FOUND:404,FORBIDDEN:403,METHOD_NOT_SUPPORTED:405,TIMEOUT:408,CONFLICT:409,PRECONDITION_FAILED:412,PAYLOAD_TOO_LARGE:413,UNSUPPORTED_MEDIA_TYPE:415,UNPROCESSABLE_CONTENT:422,TOO_MANY_REQUESTS:429,CLIENT_CLOSED_REQUEST:499,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501};function v(r){return j[r]??500}function z(r){return v(r.code)}function U(r){const{path:e,error:t,config:n}=r,{code:o}=r.error,s={message:t.message,code:V[o],data:{code:o,httpStatus:z(t)}};return n.isDev&&typeof r.error.stack=="string"&&(s.data.stack=r.error.stack),typeof e=="string"&&(s.data.path=e),n.errorFormatter({...r,shape:s})}function w(r,e){return"error"in e?{...e,error:r.transformer.output.serialize(e.error)}:"data"in e.result?{...e,result:{...e.result,data:r.transformer.output.serialize(e.result.data)}}:e}function K(r,e){return Array.isArray(e)?e.map(t=>w(r,t)):w(r,e)}function x(r){return typeof r=="function"}function G(r){const{type:e,path:t}=r,n=r.procedures[t];if(!n||!x(n)||n._def.type!==e&&!r.allowMethodOverride)throw new N({code:"NOT_FOUND",message:`No "${e}"-procedure on path "${t}"`});return n(r)}var L,M,m,F,H,k;typeof window>"u"||"Deno"in window||((M=(L=globalThis.process)==null?void 0:L.env)==null?void 0:M.NODE_ENV)==="test"||(F=(m=globalThis.process)==null?void 0:m.env)!=null&&F.JEST_WORKER_ID||(k=(H=globalThis.process)==null?void 0:H.env)!=null&&k.VITEST_WORKER_ID;function J(r){return typeof r=="object"&&r!==null&&"subscribe"in r}async function Z({router:r,createContext:e,internalId:t,message:n,event:o,subscriptions:s}){if(n.method==="subscription.stop"){const i=s.get(t);if(!i)return;i.unsubscribe(),s.delete(t);return}const{type:_,input:b,path:O,id:d}=n.operation,P=b?r._def._config.transformer.input.deserialize(b):void 0,h=await(e==null?void 0:e({event:o}))??{},u=i=>{o.sender.isDestroyed()||o.reply(T,K(r._def._config,i))};try{const i=await G({ctx:h,path:O,procedures:r._def.procedures,getRawInput:async()=>P,type:_});if(_!=="subscription"){u({id:d,result:{type:"data",data:i}});return}else if(!J(i))throw new N({message:`Subscription ${O} did not return an observable`,code:"INTERNAL_SERVER_ERROR"});const I=i.subscribe({next(S){u({id:d,result:{type:"data",data:S}})},error(S){const W=y(S);u({id:d,error:U({config:r._def._config,error:W,type:_,path:O,input:P,ctx:h})})},complete(){u({id:d,result:{type:"stopped"}})}});s.set(t,I)}catch(i){const I=y(i);return u({id:d,error:U({config:r._def._config,error:I,type:_,path:O,input:P,ctx:h})})}}const X=(r,e)=>{const t=e.method==="request"?e.operation.id:e.id;return`${r.sender.id}-${r.senderFrame.routingId}:${t}`};var E,a,f,D,C,B;class q{constructor({createContext:e,router:t,windows:n=[]}){R(this,f);R(this,C);R(this,E,[]);R(this,a,new Map);n.forEach(o=>this.attachWindow(o)),l.ipcMain.on(T,(o,s)=>{Z({router:t,createContext:e,internalId:X(o,s),event:o,message:s,subscriptions:c(this,a)})})}attachWindow(e){c(this,E).includes(e)||(c(this,E).push(e),p(this,C,B).call(this,e))}detachWindow(e){A(this,E,c(this,E).filter(t=>t!==e)),p(this,f,D).call(this,{webContentsId:e.webContents.id})}}E=new WeakMap,a=new WeakMap,f=new WeakSet,D=function({webContentsId:e,frameRoutingId:t}){for(const[n,o]of c(this,a).entries())n.startsWith(`${e}-${t??""}`)&&(o.unsubscribe(),c(this,a).delete(n))},C=new WeakSet,B=function(e){e.webContents.on("did-start-navigation",({frame:t})=>{p(this,f,D).call(this,{webContentsId:e.webContents.id,frameRoutingId:t.routingId})}),e.webContents.on("destroyed",()=>{this.detachWindow(e)})};const rr=({createContext:r,router:e,windows:t=[]})=>new q({createContext:r,router:e,windows:t}),er=()=>{const r={sendMessage:e=>l.ipcRenderer.send(T,e),onMessage:e=>l.ipcRenderer.on(T,(t,n)=>e(n))};l.contextBridge.exposeInMainWorld("electronTRPC",r)};exports.ELECTRON_TRPC_CHANNEL=T;exports.createIPCHandler=rr;exports.exposeElectronTRPC=er;
